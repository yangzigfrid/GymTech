<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GymTech Planner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Inter', sans-serif; margin:0; background:#1a202c; color:white; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding-top:2rem; }
  .day-btn { padding:1rem 1.5rem; margin:0.5rem; border-radius:0.75rem; cursor:pointer; transition:0.2s; }
  .day-btn.empty { background:#4b5563; } /* cinza para dias vazios */
  .day-btn.filled { background:#10b981; } /* verde para dias com treinos */
  .day-btn:hover { transform:scale(1.05); }
  .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:50; }
  .modal { background:#2d3748; padding:1.5rem; border-radius:1rem; max-height:80vh; overflow-y:auto; min-width:300px; position:relative; }
  .close-btn { position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; font-weight:bold; color:#f56565; }
  .workout-item { cursor:pointer; margin:0.25rem 0; }
  .edit-btn { margin-left:0.5rem; color:#ecc94b; cursor:pointer; }
  .delete-btn { margin-left:0.5rem; color:#f56565; cursor:pointer; }
</style>
</head>
<body>

<div id="app-root"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD5Bc5ex-R-jZF3sw2zSf-OJaS1dfn1e1c",
  authDomain: "gymtech-2f998.firebaseapp.com",
  projectId: "gymtech-2f998",
  storageBucket: "gymtech-2f998.appspot.com",
  messagingSenderId: "831193221171",
  appId: "1:831193221171:web:41394939052f7b46"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const appRoot = document.getElementById("app-root");

let currentUser = null;
let authError = "";
let isLoginMode = true;
let weeklyWorkouts = {};

const predefinedWorkouts = [
  { name: "Treino de Peito", exercises: [{name:"Supino Reto", description:"6-12 rep"}, {name:"Supino Inclinado", description:"6-12 rep"}], machines:["Smith Machine","Chest Press"] },
  { name: "Treino de Costas", exercises: [{name:"Puxada", description:"8-12 rep"}], machines:["Lat Pulldown"] },
  { name: "Treino de Pernas", exercises: [{name:"Agachamento", description:"6-12 rep"}], machines:["Leg Press"] },
];

const daysOfWeek = ['Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado','Domingo'];

function renderApp(){
  if(!currentUser){
    appRoot.innerHTML = `
      <div class="p-6 rounded-xl bg-gray-800 w-80 text-center">
        <h2 class="text-2xl mb-4 font-bold">${isLoginMode ? 'Login' : 'Registrar'}</h2>
        ${authError ? `<p class="bg-red-700 mb-2 p-2 rounded">${authError}</p>` : ''}
        <form id="auth-form" class="flex flex-col gap-2">
          <input id="auth-email" type="email" placeholder="Email" class="p-2 rounded"/>
          <input id="auth-password" type="password" placeholder="Senha" class="p-2 rounded"/>
          <button type="submit" class="bg-blue-600 py-2 rounded hover:bg-blue-700">${isLoginMode ? "Entrar" : "Registrar"}</button>
        </form>
        <button id="toggle-auth" class="mt-2 text-blue-400 hover:underline">${isLoginMode ? "Criar Conta" : "Login"}</button>
      </div>
    `;
    attachAuthListeners();
    return;
  }

  appRoot.innerHTML = `
    <div class="text-center">
      <h2 class="text-xl mb-4">Bem-vindo, ${currentUser.email}</h2>
      <div id="days-container" class="flex flex-wrap justify-center mb-4"></div>
      <button id="logout-btn" class="bg-red-600 py-2 px-4 rounded hover:bg-red-700">Sair</button>
    </div>
  `;

  const daysContainer = document.getElementById("days-container");
  daysOfWeek.forEach(day => {
    const btn = document.createElement("div");
    const hasWorkouts = weeklyWorkouts[day] && weeklyWorkouts[day].length > 0;
    btn.className = `day-btn ${hasWorkouts ? 'filled' : 'empty'}`;
    btn.textContent = day;
    btn.onclick = () => openDayModal(day);
    daysContainer.appendChild(btn);
  });

  document.getElementById("logout-btn").onclick = () => auth.signOut();
}

async function loadUserWorkouts(){
  if(!currentUser) return;
  const docRef = db.collection("users").doc(currentUser.uid);
  const doc = await docRef.get();
  if(doc.exists){
    weeklyWorkouts = doc.data().weeklyWorkouts;
  } else {
    weeklyWorkouts = {};
    daysOfWeek.forEach(day => weeklyWorkouts[day] = []);
    await docRef.set({ weeklyWorkouts });
  }
  renderApp();
}

async function saveUserWorkouts(){
  if(!currentUser) return;
  const docRef = db.collection("users").doc(currentUser.uid);
  await docRef.set({ weeklyWorkouts });
}

function openDayModal(day){
  const modal = document.createElement("div");
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal">
      <h2 class="text-xl font-bold mb-2">${day}</h2>
      <ul id="workout-list">
        ${weeklyWorkouts[day].map((w,i)=>`<li class="workout-item" data-index="${i}">${w.name}
          <span class="edit-btn" data-index="${i}">Editar</span>
          <span class="delete-btn" data-index="${i}">Excluir</span>
        </li>`).join('')}
      </ul>
      <select id="add-workout-select" class="p-2 rounded mb-2">
        <option value="">Selecionar treino</option>
        ${predefinedWorkouts.map((w,i)=>`<option value="${i}">${w.name}</option>`).join('')}
      </select>
      <button id="add-workout-btn" class="bg-green-600 py-1 px-3 rounded hover:bg-green-700">Adicionar Treino</button>
      <span class="close-btn">&times;</span>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector(".close-btn").onclick = () => { modal.remove(); renderApp(); };

  modal.querySelectorAll(".workout-item").forEach(li=>{
    li.onclick = (e)=>{
      if(e.target.tagName === 'SPAN') return;
      const idx = li.getAttribute("data-index");
      renderWorkoutDetailModal(weeklyWorkouts[day][idx]);
    };
  });

  modal.querySelector("#add-workout-btn").onclick = async () => {
    const sel = modal.querySelector("#add-workout-select");
    if(sel.value === "") return;
    weeklyWorkouts[day].push(predefinedWorkouts[sel.value]);
    await saveUserWorkouts();
    modal.remove();
    openDayModal(day);
  };

  modal.querySelectorAll(".edit-btn").forEach(btn=>{
    btn.onclick = async (e)=>{
      e.stopPropagation();
      const idx = btn.getAttribute("data-index");
      const workout = weeklyWorkouts[day][idx];
      const newName = prompt("Editar nome do treino:", workout.name);
      if(newName) workout.name = newName;
      await saveUserWorkouts();
      modal.remove();
      openDayModal(day);
    };
  });

  modal.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.onclick = async (e)=>{
      e.stopPropagation();
      const idx = btn.getAttribute("data-index");
      weeklyWorkouts[day].splice(idx,1);
      await saveUserWorkouts();
      modal.remove();
      openDayModal(day);
    };
  });
}

function renderWorkoutDetailModal(workout){
  const modal = document.createElement("div");
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal">
      <h2 class="text-xl font-bold mb-2">${workout.name}</h2>
      <h3>Exercícios:</h3>
      <ul>${workout.exercises.map(e=>`<li>${e.name}: ${e.description}</li>`).join('')}</ul>
      <h3>Máquinas:</h3>
      <ul>${workout.machines.map(m=>`<li>${m}</li>`).join('')}</ul>
      <span class="close-btn">&times;</span>
    </div>
  `;
  document.body.appendChild(modal);
  modal.querySelector(".close-btn").onclick = ()=>modal.remove();
}

function attachAuthListeners(){
  const form = document.getElementById("auth-form");
  if(form){
    form.onsubmit = async e=>{
      e.preventDefault();
      const email = document.getElementById("auth-email").value;
      const password = document.getElementById("auth-password").value;
      try{
        if(isLoginMode){
          const cred = await auth.signInWithEmailAndPassword(email,password);
          currentUser = cred.user;
        } else {
          const cred = await auth.createUserWithEmailAndPassword(email,password);
          currentUser = cred.user;
        }
        authError = "";
      }catch(err){
        authError = err.message;
      }
      await loadUserWorkouts();
    };
  }
  const toggleBtn = document.getElementById("toggle-auth");
  if(toggleBtn) toggleBtn.onclick = ()=>{
    isLoginMode = !isLoginMode;
    authError = "";
    renderApp();
  };
}

auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user) await loadUserWorkouts();
  else renderApp();
});

renderApp();
</script>

</body>
</html>
