<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Treinos</title>
    <!-- Tailwind CSS CDN para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter para um visual moderno e limpo -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Estilos base e fontes */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-image: url('https://i.postimg.cc/Y4rqjL3K/background-gym.jpg'); /* Imagem de fundo da academia */
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #1a202c; /* Cor padrão do texto */
        }
        .dark body { /* Estilo para possível modo escuro (não implementado, mas boa prática) */
            color: #f7fafc;
        }
        /* Overlay escuro sobre a imagem de fundo para melhorar a legibilidade do texto */
        .bg-overlay {
            position: absolute;
            inset: 0;
            background-color: black;
            opacity: 0.6;
            z-index: 0; /* Garante que fique atrás do conteúdo principal */
        }
        /* Animação personalizada para o título principal */
        @keyframes pulse-fade {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }
        .animate-pulse-fade {
            animation: pulse-fade 3s ease-in-out infinite;
        }
        /* Animação para modais (pop-ups) */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        /* Animação para mensagens temporárias (erros/sucesso) */
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-overlay"></div>
    <div id="app-root" class="relative z-10 w-full max-w-4xl rounded-2xl p-6 md:p-8 my-8 flex flex-col items-center">
        <!-- O conteúdo da aplicação será injetado aqui pelo JavaScript -->
        <div class="flex justify-center items-center h-full min-h-[300px] text-xl text-gray-700 dark:text-gray-300">
            Carregando aplicativo...
        </div>
    </div>

    <!-- Firebase SDKs - Carregados antes do script principal -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>


    <script>
        // Use uma IIFE (Immediately Invoked Function Expression) para encapsular todo o código JavaScript
        // Isso ajuda a evitar poluição do escopo global.
        (function() {
            // Firebase Configuration - Usando as informações fornecidas
            const firebaseConfig = {
                apiKey: "AIzaSyD5Bc5ex-R-jZF3sw2zSf-OJaS1dfn1e1c",
                authDomain: "gymtech-2f998.firebaseapp.com",
                projectId: "gymtech-2f998",
                storageBucket: "gymtech-2f998.firebasestorage.app",
                messagingSenderId: "831193221171",
                appId: "1:831193221171:web:41394939016959052f7b46",
                measurementId: "G-MHEF18CNYY"
            };

            // Inicializa Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const analytics = firebase.analytics(); // Inicializa o Analytics, se necessário

            // Definindo um ID de aplicativo padrão para o Firestore, se não for fornecido pelo ambiente
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'gym-app-default';

            // --- Variáveis de Estado da Aplicação ---
            let currentUser = null; // Armazena o objeto do usuário logado do Firebase
            let userId = null; // Armazena o UID do usuário para caminhos do Firestore
            let workouts = { // Armazena os treinos organizados por dia
                'Segunda-feira': [],
                'Terça-feira': [],
                'Quarta-feira': [],
                'Quinta-feira': [],
                'Sexta-feira': [],
                'Sábado': [],
                'Domingo': [],
            };
            let diet = ''; // Armazena o plano de dieta
            let weight = ''; // Armazena o peso atual
            let authError = ''; // Mensagem de erro para autenticação ou outras ações
            let editingWorkout = null; // Armazena o treino que está sendo editado (ou null)
            let currentDay = ''; // O dia da semana atualmente selecionado para adicionar/editar treino
            let workoutToDelete = null; // Referência ao treino a ser excluído

            // Variáveis para controlar a visibilidade dos modais
            let isWorkoutModalOpen = false;
            let isDietModalOpen = false;
            let isWeightModalOpen = false;
            let isConfirmationModalOpen = false;
            let isLoginMode = true; // Estado para alternar entre Login e Cadastro
            let currentView = 'main'; // Controla a visão atual: 'main' ou 'dayDetail'

            // Elemento raiz onde a aplicação será renderizada
            const appRoot = document.getElementById('app-root');
            // Nomes dos dias da semana para iteração e exibição
            const daysOfWeek = [
                'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira',
                'Sexta-feira', 'Sábado', 'Domingo'
            ];

            // --- Dados dos Treinos Pré-definidos ---
            const workoutDetails = {
                'Treino de Peito': {
                    exercises: [
                        { name: 'Supino Reto (Barra ou Halteres)', description: '6-12 repetições. Este exercício é ideal para construir massa muscular no peitoral (hipertrofia). O uso de pesos mais pesados com menos repetições promove a força.' },
                        { name: 'Supino Inclinado (Barra ou Halteres)', description: '6-12 repetições. Foca na parte superior do peito, que é muitas vezes menos desenvolvida.' },
                        { name: 'Supino Declinado (Barra ou Halteres)', description: '8-15 repetições. Ativa a parte inferior do peito.' },
                        { name: 'Crucifixo com Halteres', description: '10-15 repetições. O movimento de abertura e fechamento alonga o músculo peitoral, promovendo flexibilidade e detalhe muscular.' },
                        { name: 'Crossover (Crossover Machine)', description: '10-15 repetições. Ótimo para isolar o peito e dar uma sensação de "pump".' }
                    ],
                    machines: [
                        { name: 'Smith Machine', description: 'Para supino reto e inclinado. Oferece mais estabilidade, bom para iniciantes.' },
                        { name: 'Máquina de Peito (Chest Press Machine)', description: 'Para supino. Permite o ajuste do peso facilmente e é mais seguro.' },
                        { name: 'Crossover Machine (Máquina de Polia)', description: 'Para o exercício de crossover.' },
                        { name: 'Máquina de Crucifixo (Pec Deck)', description: 'Para isolar o peito.' }
                    ]
                },
                'Treino de Costas': {
                    exercises: [
                        { name: 'Puxada na Polia (Lat Pulldown Machine)', description: '8-12 repetições. É um dos exercícios mais eficazes para a largura das costas. A puxada com menos repetições e mais peso desenvolve a força, enquanto mais repetições com menos peso melhoram a resistência.' },
                        { name: 'Remada Curvada (Barra ou Halteres)', description: '6-12 repetições. Constrói densidade nas costas e fortalece a lombar e os bíceps.' },
                        { name: 'Remada na Máquina (Seated Row Machine)', description: '8-12 repetições. Ótimo para isolar as costas e melhorar a espessura.' },
                        { name: 'Hiperextensão (Hyper Extension Machine)', description: '10-15 repetições. Fortalece a parte inferior das costas e glúteos.' },
                        { name: 'Barra Fixa (Pull-ups)', description: 'Máximo de repetições possível. É um dos melhores exercícios de peso corporal para as costas.' }
                    ],
                    machines: [
                        { name: 'Máquina de Puxada Alta (Lat Pulldown Machine)', description: 'Para puxadas frontais e com pegada supinada.' },
                        { name: 'Máquina de Remada (Seated Row Machine)', description: 'Para remadas com pegada aberta, fechada e neutra.' },
                        { name: 'Máquina de Remada T (T-Bar Row Machine)', description: 'Para remadas com peso livre.' }
                    ]
                },
                'Treino de Pernas e Glúteos': {
                    exercises: [
                        { name: 'Agachamento (Squat Rack)', description: '6-12 repetições. O agachamento é considerado o "rei" dos exercícios. Ele trabalha a perna inteira e glúteos, sendo ideal para hipertrofia e força.' },
                        { name: 'Leg Press (Leg Press Machine)', description: '8-15 repetições. Permite o uso de cargas pesadas com menos estresse na coluna.' },
                        { name: 'Cadeira Extensora (Leg Extension Machine)', description: '10-20 repetições. Isola o quadríceps. Repetições mais altas são ótimas para o "pump" e resistência.' },
                        { name: 'Cadeira Flexora (Leg Curl Machine)', description: '10-20 repetições. Isola a parte posterior da coxa (isquiotibiais).' },
                        { name: 'Panturrilha (Calf Raise Machine)', description: '15-20 repetições. A panturrilha é um músculo resistente, e por isso precisa de mais repetições.' },
                        { name: 'Abdução e Adução (Abductor e Adductor Machine)', description: '15-20 repetições. Trabalham os músculos da coxa interna e externa, importantes para estabilidade e contorno.' }
                    ],
                    machines: [
                        { name: 'Leg Press Machine', description: 'Para o exercício de leg press.' },
                        { name: 'Smith Machine', description: 'Para agachamento e lunges.' },
                        { name: 'Máquina de Extensão de Pernas (Leg Extension Machine)', description: 'Para o exercício de cadeira extensora.' },
                        { name: 'Máquina de Flexão de Pernas (Leg Curl Machine)', description: 'Para o exercício de cadeira flexora.' },
                        { name: 'Máquina de Panturrilha (Calf Raise Machine)', description: 'Para o exercício de elevação de panturrilha.' }
                    ]
                },
                'Treino de Ombros': {
                    exercises: [
                        { name: 'Desenvolvimento com Halteres (Dumbbell Shoulder Press)', description: '8-12 repetições. Exercício principal para o desenvolvimento geral do ombro.' },
                        { name: 'Elevação Lateral (Halteres ou Polia)', description: '10-15 repetições. Essencial para a largura do ombro (deltoide medial).' },
                        { name: 'Remada Alta (Barra ou Polia)', description: '10-15 repetições. Trabalha a parte superior do trapézio e o deltoide.' },
                        { name: 'Desenvolvimento na Máquina (Shoulder Press Machine)', description: '8-12 repetições. Mais seguro para iniciantes e para focar no músculo.' }
                    ],
                    machines: [
                        { name: 'Smith Machine', description: 'Para o exercício de desenvolvimento (shoulder press).' },
                        { name: 'Máquina de Desenvolvimento de Ombro (Shoulder Press Machine)', description: 'Para o exercício de desenvolvimento.' }
                    ]
                },
                'Treino de Braços (Bíceps e Tríceps)': {
                    exercises: [
                        { name: 'Rosca Direta (Barra)', description: '8-12 repetições. Trabalha o bíceps como um todo.' },
                        { name: 'Rosca Alternada (Halteres)', description: '10-15 repetições. Ajuda a corrigir desequilíbrios entre os braços.' },
                        { name: 'Rosca Concentrada (Halteres)', description: '10-15 repetições. Ótimo para isolar o músculo e focar na contração.' },
                        { name: 'Tríceps Testa (Barra ou Halteres)', description: '8-12 repetições. Um dos exercícios mais eficazes para a massa do tríceps.' },
                        { name: 'Tríceps Pulley (Máquina de Polia)', description: '10-15 repetições. Ótimo para isolamento e para dar forma ao músculo.' },
                        { name: 'Tríceps Coice (Halteres)', description: '10-15 repetições. Foca na cabeça longa do tríceps.' }
                    ],
                    machines: [] // Não há máquinas específicas listadas para este treino no seu prompt
                }
            };

            // --- Funções Auxiliares para Manipulação do DOM e Lógica Geral ---

            /**
             * Renderiza um modal genérico na tela.
             * @param {boolean} isOpen - Se o modal deve estar visível.
             * @param {string} title - Título do modal.
             * @param {string} contentHtml - Conteúdo HTML a ser inserido no corpo do modal.
             * @param {Function} closeCallback - Função a ser chamada ao fechar o modal.
             */
            function renderModal(isOpen, title, contentHtml, closeCallback) {
                const existingModal = document.getElementById('generic-modal-wrapper');
                if (existingModal) {
                    existingModal.remove(); // Sempre remove qualquer modal existente
                }

                if (!isOpen) {
                    return; // Se não deve estar aberto, retorna após remover
                }

                const modalWrapper = document.createElement('div');
                modalWrapper.id = 'generic-modal-wrapper';
                modalWrapper.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50';

                const modalContent = document.createElement('div');
                modalContent.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative animate-fade-in-up';

                const modalTitle = document.createElement('h2');
                modalTitle.className = 'text-2xl font-bold mb-4 text-gray-800 dark:text-white border-b pb-2';
                modalTitle.textContent = title;

                const closeButton = document.createElement('button');
                closeButton.className = 'absolute top-3 right-3 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-3xl font-bold';
                closeButton.innerHTML = '&times;'; // Ícone de fechar
                closeButton.onclick = closeCallback; // Atribui a função de fechar

                const contentContainer = document.createElement('div');
                contentContainer.innerHTML = contentHtml; // Insere o HTML do conteúdo fornecido

                modalContent.appendChild(modalTitle);
                modalContent.appendChild(closeButton);
                modalContent.appendChild(contentContainer);
                modalWrapper.appendChild(modalContent);

                document.body.appendChild(modalWrapper); // Adiciona o modal ao corpo do documento
            }

            /**
             * Renderiza o modal de confirmação para exclusão de treino.
             */
            function renderConfirmationModal() {
                const message = "Tem certeza que deseja excluir este treino?";
                const contentHtml = `
                    <p class="text-gray-700 dark:text-gray-300 mb-6 text-center">${message}</p>
                    <div class="flex justify-around space-x-4">
                        <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                            Confirmar
                        </button>
                        <button id="cancel-delete-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                            Cancelar
                        </button>
                    </div>
                `;
                renderModal(isConfirmationModalOpen, "Confirmação", contentHtml, cancelDeleteWorkout);

                if (isConfirmationModalOpen) {
                    // Atribui os event listeners aos botões do modal de confirmação
                    document.getElementById('confirm-delete-btn').onclick = confirmDeleteWorkout;
                    document.getElementById('cancel-delete-btn').onclick = cancelDeleteWorkout;
                }
            }

            /**
             * Exibe uma mensagem temporária (erro ou sucesso) na interface.
             * @param {string} message - A mensagem a ser exibida.
             * @param {'error'|'success'} type - O tipo da mensagem (controla a cor).
             */
            function showTempMessage(message, type) {
                authError = message; // Atualiza a variável de estado da mensagem de erro
                renderApp(); // Força a re-renderização para mostrar a mensagem
                setTimeout(() => {
                    authError = ''; // Limpa a mensagem após 3 segundos
                    renderApp(); // Força a re-renderização para esconder a mensagem
                }, 3000);
            }

            /**
             * Limpa a mensagem de erro atual.
             */
            function clearAuthError() {
                authError = '';
                renderApp(); // Re-renderiza para remover a mensagem da UI
            }

            // --- Funções de Autenticação com Firebase ---

            /**
             * Tenta fazer login de um usuário com e-mail e senha no Firebase.
             * @param {string} email - O e-mail do usuário.
             * @param {string} password - A senha do usuário.
             */
            async function handleLogin(email, password) {
                try {
                    clearAuthError(); // Limpa quaisquer erros anteriores
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;
                    userId = currentUser.uid;
                    await loadUserData(currentUser); // Carrega os dados do usuário após o login
                    renderApp(); // Re-renderiza para a tela principal da aplicação
                } catch (error) {
                    console.error("Erro ao fazer login:", error);
                    let errorMessage = 'Erro ao fazer login. Verifique seu e-mail e senha.';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Usuário não encontrado.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Senha incorreta.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Formato de e-mail inválido.';
                    }
                    showTempMessage(errorMessage, 'error'); // Exibe a mensagem de erro
                }
            }

            /**
             * Tenta registrar um novo usuário com e-mail e senha no Firebase.
             * @param {string} email - O e-mail do novo usuário.
             * @param {string} password - A senha do novo usuário.
             */
            async function handleRegister(email, password) {
                try {
                    clearAuthError(); // Limpa quaisquer erros anteriores
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;
                    userId = currentUser.uid;
                    // Não há dados para carregar para um novo usuário, mas ele está logado e pronto para inserir dados
                    renderApp(); // Re-renderiza para a tela principal da aplicação
                } catch (error) {
                    console.error("Erro ao registrar:", error);
                    let errorMessage = 'Erro ao registrar. Tente novamente.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Este e-mail já está em uso.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Formato de e-mail inválido.';
                    }
                    showTempMessage(errorMessage, 'error'); // Exibe a mensagem de erro
                }
            }

            /**
             * Realiza o logout do usuário atual do Firebase.
             */
            async function handleLogout() {
                try {
                    await auth.signOut(); // Faz logout do Firebase
                    currentUser = null; // Limpa o usuário atual
                    userId = null;
                    // Limpa o estado local de treinos, dieta e peso para a próxima sessão
                    workouts = {
                        'Segunda-feira': [], 'Terça-feira': [], 'Quarta-feira': [], 'Quinta-feira': [],
                        'Sexta-feira': [], 'Sábado': [], 'Domingo': [],
                    };
                    diet = '';
                    weight = '';
                    renderApp(); // Re-renderiza para a tela de autenticação
                } catch (error) {
                    console.error("Erro ao fazer logout:", error);
                    showTempMessage('Erro ao fazer logout. Tente novamente.', 'error');
                }
            }

            // --- Funções para Carregar Dados do Firebase Firestore ---

            /**
             * Carrega os dados (treinos, dieta, peso) do usuário logado do Firestore.
             * @param {object} userObj - O objeto do usuário Firebase atual.
             */
            async function loadUserData(userObj) {
                if (!userObj || !userObj.uid) return;

                try {
                    // 1. Carrega Treinos
                    const workoutsCollectionRef = db.collection(`artifacts/${appId}/users/${userObj.uid}/workouts`);
                    const workoutsSnapshot = await workoutsCollectionRef.get();
                    const loadedWorkouts = {
                        'Segunda-feira': [], 'Terça-feira': [], 'Quarta-feira': [], 'Quinta-feira': [],
                        'Sexta-feira': [], 'Sábado': [], 'Domingo': [],
                    };
                    workoutsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const day = data.day;
                        if (loadedWorkouts[day]) {
                            loadedWorkouts[day].push({
                                id: doc.id, // ID do documento Firestore
                                name: data.name,
                                description: data.description,
                            });
                        }
                    });
                    workouts = loadedWorkouts;

                    // 2. Carrega Dieta
                    const dietDocRef = db.collection(`artifacts/${appId}/users/${userObj.uid}/diet`).doc('userDietDoc');
                    const dietDoc = await dietDocRef.get();
                    if (dietDoc.exists) {
                        diet = dietDoc.data().plan;
                    } else {
                        diet = '';
                    }

                    // 3. Carrega Peso (a entrada mais recente)
                    const weightsCollectionRef = db.collection(`artifacts/${appId}/users/${userObj.uid}/weights`);
                    // IMPORTANT: Firebase orderBy() requires an index if you're querying on multiple fields or ranges.
                    // To avoid needing to create an index manually, we will fetch all weights and sort them in memory.
                    // For a production app with many weight entries, a proper Firestore index would be more efficient.
                    const allWeightsSnapshot = await weightsCollectionRef.get();
                    const allWeights = [];
                    allWeightsSnapshot.forEach(doc => {
                        allWeights.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort weights by createdAt timestamp in descending order (most recent first)
                    allWeights.sort((a, b) => {
                        // Handle Firebase Timestamps
                        const timeA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                        const timeB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                        return timeB - timeA;
                    });

                    if (allWeights.length > 0) {
                        weight = allWeights[0].value;
                    } else {
                        weight = '';
                    }

                    // Não chame renderApp() aqui. A renderização é controlada explicitamente após operações de dados.
                } catch (error) {
                    console.error("Erro ao carregar dados do usuário:", error);
                    showTempMessage('Erro ao carregar seus dados. Tente novamente.', 'error');
                }
            }

            // --- Funções para manipulação de Treinos ---

            /**
             * Abre o modal para adicionar um novo treino para um dia específico.
             * @param {string} day - O dia da semana para o qual o treino será adicionado.
             */
            function openAddWorkoutModal(day) {
                console.log(`Abrindo modal para adicionar treino para: ${day}`); // Depuração
                editingWorkout = null; // Garante que não estamos em modo de edição
                currentDay = day;
                isWorkoutModalOpen = true; // Abre o modal
                renderWorkoutModal(); // Chama diretamente a renderização do modal
            }

            /**
             * Abre o modal para editar um treino existente.
             * @param {string} day - O dia da semana do treino.
             * @param {object} workout - O objeto do treino a ser editado.
             */
            function openEditWorkoutModal(day, workout) {
                console.log(`Abrindo modal para editar treino para: ${day}, Workout ID: ${workout.id}`); // Depuração
                editingWorkout = workout; // Define o treino a ser editado
                currentDay = day;
                isWorkoutModalOpen = true; // Abre o modal
                renderWorkoutModal(); // Chama diretamente a renderização do modal
            }

            /**
             * Fecha o modal de adicionar/editar treino e limpa o estado relacionado.
             */
            function closeWorkoutModal() {
                console.log('Fechando modal de treino.'); // Depuração
                isWorkoutModalOpen = false;
                editingWorkout = null;
                currentDay = '';
                renderWorkoutModal(); // Chama diretamente a renderização do modal para fechar
            }

            /**
             * Lida com o salvamento (adição ou edição) de um treino no Firestore.
             * @param {Event} event - O evento de submissão do formulário.
             */
            async function handleSaveWorkout(event) {
                event.preventDefault(); // Impede o recarregamento da página
                if (!userId) {
                    showTempMessage('Usuário não autenticado. Faça login para salvar treinos.', 'error');
                    return;
                }

                const form = event.target;
                const workoutType = form.workoutName.value; // Pega o valor do select de tipo de treino
                const exerciseName = form.workoutExercise.value; // Pega o valor do select de exercício

                if (!workoutType.trim() || workoutType === "Selecione o treino") {
                    showTempMessage('Por favor, selecione um tipo de treino.', 'error');
                    return;
                }
                if (!exerciseName.trim() || exerciseName === "Selecione o Exercício") {
                    showTempMessage('Por favor, selecione um exercício.', 'error');
                    return;
                }

                // Constrói a descrição concisa para exibição e salvamento
                let descriptionToSave = `${exerciseName}`; // Apenas o exercício e repetições

                try {
                    const workoutsCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/workouts`);
                    if (editingWorkout) {
                        // Modo de Edição: Atualiza um treino existente
                        const workoutDocRef = workoutsCollectionRef.doc(editingWorkout.id);
                        await workoutDocRef.update({ name: workoutType, description: descriptionToSave });

                        // Atualiza o estado local para refletir as mudanças na UI
                        workouts[currentDay] = workouts[currentDay].map(w =>
                            w.id === editingWorkout.id ? { ...w, name: workoutType, description: descriptionToSave } : w
                        );
                    } else {
                        // Modo de Adição: Cria um novo treino
                        const newWorkoutDocRef = await workoutsCollectionRef.add({
                            name: workoutType,
                            description: descriptionToSave,
                            day: currentDay,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp() // Adiciona timestamp do servidor
                        });

                        // Adiciona o novo treino ao estado local
                        workouts[currentDay].push({
                            id: newWorkoutDocRef.id,
                            name: workoutType,
                            description: descriptionToSave,
                        });
                    }
                    closeWorkoutModal(); // Fecha o modal após salvar
                    // Recarrega os dados e renderiza a tela correta para mostrar as atualizações
                    await loadUserData(currentUser);
                    if (currentView === 'dayDetail') {
                        renderDayDetailScreen();
                    } else {
                        renderMainApp();
                    }
                } catch (error) {
                    console.error("Erro ao salvar treino:", error);
                    let errorMessage = 'Erro ao salvar treino. Tente novamente.';
                    if (error.code) {
                        errorMessage += ` Código: ${error.code}.`;
                    }
                    if (error.message) {
                        errorMessage += ` Mensagem: ${error.message}.`;
                    }
                    showTempMessage(errorMessage, 'error');
                }
            }

            /**
             * Prepara para excluir um treino, abrindo o modal de confirmação.
             * @param {string} day - O dia do treino a ser excluído.
             * @param {string} workoutId - O ID do treino a ser excluído.
             */
            function handleDeleteWorkoutClick(day, workoutId) {
                console.log(`Preparando para excluir treino: ${day}, ID: ${workoutId}`); // Depuração
                workoutToDelete = { day, workoutId }; // Armazena o treino para exclusão
                isConfirmationModalOpen = true; // Abre o modal de confirmação
                renderConfirmationModal(); // Chama diretamente a renderização do modal
            }

            /**
             * Confirma e executa a exclusão de um treino no Firestore.
             */
            async function confirmDeleteWorkout() {
                console.log('Confirmando exclusão de treino.'); // Depuração
                if (!userId) {
                    showTempMessage('Usuário não autenticado. Faça login para excluir treinos.', 'error');
                    return;
                }
                if (workoutToDelete) {
                    try {
                        const workoutDocRef = db.collection(`artifacts/${appId}/users/${userId}/workouts`).doc(workoutToDelete.workoutId);
                        await workoutDocRef.delete(); // Exclui o treino do Firestore

                        // Remove o treino do estado local
                        workouts[workoutToDelete.day] = workouts[workoutToDelete.day].filter(
                            workout => workout.id !== workoutToDelete.workoutId
                        );
                    } catch (error) {
                        console.error("Erro ao excluir treino:", error);
                        let errorMessage = 'Erro ao excluir treino. Tente novamente.';
                        if (error.code) {
                            errorMessage += ` Código: ${error.code}.`;
                        }
                        if (error.message) {
                            errorMessage += ` Mensagem: ${error.message}.`;
                        }
                        showTempMessage(errorMessage, 'error');
                    }
                }
                isConfirmationModalOpen = false; // Fecha o modal de confirmação
                workoutToDelete = null; // Limpa a referência do treino a ser excluído
                renderConfirmationModal(); // Chama diretamente a renderização do modal para fechar
                // Recarrega os dados e renderiza a tela correta para mostrar as atualizações
                await loadUserData(currentUser);
                if (currentView === 'dayDetail') {
                    renderDayDetailScreen();
                } else {
                    renderMainApp();
                }
            }

            /**
             * Cancela a exclusão de um treino, fechando o modal de confirmação.
             */
            function cancelDeleteWorkout() {
                console.log('Cancelando exclusão de treino.'); // Depuração
                isConfirmationModalOpen = false;
                workoutToDelete = null;
                renderConfirmationModal(); // Chama diretamente a renderização do modal para fechar
            }

            // --- Funções para manipulação de Dieta ---

            /**
             * Abre o modal de dieta.
             */
            function openDietModal() {
                console.log('Abrindo modal de dieta.'); // Depuração
                isDietModalOpen = true;
                renderDietModal(); // Chama diretamente a renderização do modal
            }

            /**
             * Fecha o modal de dieta.
             */
            function closeDietModal() {
                console.log('Fechando modal de dieta.'); // Depuração
                isDietModalOpen = false;
                renderDietModal(); // Chama diretamente a renderização do modal para fechar
            }

            /**
             * Lida com o salvamento (adição ou edição) do plano de dieta no Firestore.
             * @param {Event} event - O evento de submissão do formulário.
             */
            async function handleSaveDiet(event) {
                event.preventDefault();
                if (!userId) {
                    showTempMessage('Usuário não autenticado. Faça login para salvar a dieta.', 'error');
                    return;
                }
                const dietPlan = event.target.dietPlan.value;

                try {
                    const dietDocRef = db.collection(`artifacts/${appId}/users/${userId}/diet`).doc('userDietDoc');
                    await dietDocRef.set({ plan: dietPlan }, { merge: true }); // Usa set com merge para criar ou atualizar

                    diet = dietPlan; // Atualiza o estado local
                    closeDietModal(); // Fecha o modal
                    // Recarrega os dados e renderiza a tela principal para mostrar as atualizações
                    await loadUserData(currentUser);
                    renderMainApp();
                } catch (error) {
                    console.error("Erro ao salvar dieta:", error);
                    let errorMessage = 'Erro ao salvar dieta. Tente novamente.';
                    if (error.code) {
                        errorMessage += ` Código: ${error.code}.`;
                    }
                    if (error.message) {
                        errorMessage += ` Mensagem: ${error.message}.`;
                    }
                    showTempMessage(errorMessage, 'error');
                }
            }

            // --- Funções para manipulação de Peso ---

            /**
             * Abre o modal de peso.
             */
            function openWeightModal() {
                console.log('Abrindo modal de peso.'); // Depuração
                isWeightModalOpen = true;
                renderWeightModal(); // Chama diretamente a renderização do modal
            }

            /**
             * Fecha o modal de peso.
             */
            function closeWeightModal() {
                console.log('Fechando modal de peso.'); // Depuração
                isWeightModalOpen = false;
                renderWeightModal(); // Chama diretamente a renderização do modal para fechar
            }

            /**
             * Lida com o salvamento de um novo registro de peso no Firestore.
             * @param {Event} event - O evento de submissão do formulário.
             */
            async function handleSaveWeight(event) {
                event.preventDefault();
                if (!userId) {
                    showTempMessage('Usuário não autenticado. Faça login para registrar o peso.', 'error');
                    return;
                }
                const newWeightValue = parseFloat(event.target.newWeight.value);

                if (isNaN(newWeightValue) || newWeightValue <= 0) { // Validação do peso
                    showTempMessage('Por favor, insira um peso válido.', 'error');
                    return;
                }

                try {
                    // Sempre cria uma nova entrada de peso (para manter um histórico)
                    await db.collection(`artifacts/${appId}/users/${userId}/weights`).add({
                        value: newWeightValue,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() // Adiciona timestamp do servidor
                    });

                    weight = newWeightValue; // Atualiza o estado local com o último peso
                    closeWeightModal(); // Fecha o modal
                    // Recarrega os dados e renderiza a tela principal para mostrar as atualizações
                    await loadUserData(currentUser);
                    renderMainApp();
                } catch (error) {
                    console.error("Erro ao salvar peso:", error);
                    let errorMessage = 'Erro ao salvar peso. Tente novamente.';
                    if (error.code) {
                        errorMessage += ` Código: ${error.code}.`;
                    }
                    if (error.message) {
                        errorMessage += ` Mensagem: ${error.message}.`;
                    }
                    showTempMessage(errorMessage, 'error');
                }
            }

            // --- Funções de Renderização Principal (Redesenham a UI) ---

            /**
             * Renderiza a tela de autenticação (Login/Cadastro).
             */
            function renderAuthScreen() {
                appRoot.innerHTML = `
                    <div class="relative z-10 rounded-2xl shadow-2xl p-6 md:p-8 my-8 w-full max-w-sm mx-auto text-center flex flex-col items-center">
                        <h2 id="auth-title" class="text-3xl md:text-4xl font-extrabold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500 drop-shadow-lg">
                            ${isLoginMode ? 'Login' : 'Criar Conta'}
                        </h2>
                        ${authError ? `<div class="bg-red-500 text-white p-3 rounded-md mb-4 flex justify-between items-center animate-fade-in"><span>${authError}</span><button id="clear-error-btn" class="font-bold text-lg">&times;</button></div>` : ''}
                        <form id="auth-form" class="space-y-6 w-full max-w-xs">
                            <div>
                                <input type="email" placeholder="E-mail" id="auth-email" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 bg-transparent text-white placeholder-gray-300" required />
                            </div>
                            <div>
                                <input type="password" placeholder="Senha" id="auth-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 bg-transparent text-white placeholder-gray-300" required />
                            </div>
                            <button type="submit" id="auth-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                ${isLoginMode ? 'Entrar' : 'Registrar'}
                            </button>
                        </form>
                        <button id="toggle-auth-mode-btn" class="mt-6 text-blue-300 hover:underline transition-colors duration-300">
                            ${isLoginMode ? 'Não tem uma conta? Crie uma!' : 'Já tem uma conta? Faça login!'}
                        </button>
                    </div>
                `;

                // Adiciona event listeners aos elementos da tela de autenticação após eles serem criados no DOM
                const authTitle = document.getElementById('auth-title');
                const authSubmitBtn = document.getElementById('auth-submit-btn');
                const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
                const authForm = document.getElementById('auth-form');
                const authEmail = document.getElementById('auth-email');
                const authPassword = document.getElementById('auth-password');
                const clearErrorBtn = document.getElementById('clear-error-btn');

                if (clearErrorBtn) {
                    clearErrorBtn.onclick = clearAuthError;
                }

                authForm.onsubmit = (e) => {
                    e.preventDefault();
                    const email = authEmail.value;
                    const password = authPassword.value;
                    if (isLoginMode) {
                        handleLogin(email, password);
                    } else {
                        handleRegister(email, password);
                    }
                };
            }

            /**
             * Renderiza a interface principal da aplicação (todos os dias da semana).
             */
            function renderMainApp() {
                let workoutsHtml = '';
                // Loop pelos dias da semana para gerar o HTML dos treinos
                for (const day of daysOfWeek) {
                    workoutsHtml += `
                        <div data-day="${day}" class="day-box-clickable cursor-pointer bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-700 rounded-xl p-5 shadow-lg transform hover:scale-102 transition-all duration-300">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-300 dark:border-gray-600 pb-2">${day}</h3>
                            <!-- Conteúdo dos treinos removido desta tela para ser mais clean -->
                        </div>
                    `;
                }

                // Define o HTML interno do elemento raiz da aplicação
                appRoot.innerHTML = `
                    <div class="flex justify-between items-center mb-10">
                        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500 drop-shadow-lg animate-pulse-fade">
                            💪 Meu Diário de Treinos 💪
                        </h1>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                            Sair
                        </button>
                    </div>

                    <div class="bg-amber-800 bg-opacity-90 text-white p-3 rounded-md mb-4 animate-fade-in text-center border-l-4 border-yellow-400">
                        <p class="font-bold text-sm mb-1">A escolha das repetições deve sempre estar alinhada com o seu objetivo principal:</p>
                        <ul class="list-disc list-inside mx-auto max-w-fit text-left text-xs">
                            <li><strong>Força (1-5 repetições):</strong> Usando cargas muito pesadas.</li>
                            <li><strong>Hipertrofia (6-12 repetições):</strong> O mais comum para ganho de massa muscular.</li>
                            <li><strong>Resistência (15+ repetições):</strong> Usando cargas leves a moderadas.</li>
                        </ul>
                    </div>

                    ${authError ? `<div class="bg-red-500 text-white p-3 rounded-md mb-4 flex justify-between items-center animate-fade-in"><span>${authError}</span><button id="clear-error-btn" class="font-bold text-lg">&times;</button></div>` : ''}

                    <section class="mb-12">
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Seus Treinos Semanaais</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${workoutsHtml}
                        </div>
                    </section>

                    <div class="flex flex-col md:flex-row gap-6 w-full justify-center">
                        <section class="mb-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-6 shadow-xl transform hover:scale-102 transition-all duration-300 flex-1">
                            <h2 class="text-3xl font-bold text-white text-center mb-4">Sua Dieta</h2>
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-inner min-h-[100px] flex items-center justify-center">
                                ${diet ? `<p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap text-lg text-center">${diet}</p>` : `<p class="text-gray-500 dark:text-gray-400 italic text-lg text-center">Nenhuma dieta adicionada ainda.</p>`}
                            </div>
                            <button id="open-diet-modal-btn" class="mt-6 w-full bg-white text-emerald-700 hover:bg-gray-100 font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                                ${diet ? 'Editar Dieta' : 'Adicionar Dieta'}
                            </button>
                        </section>

                        <section class="mb-12 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl p-6 shadow-xl transform hover:scale-102 transition-all duration-300 flex-1">
                            <h2 class="text-3xl font-bold text-white text-center mb-4">Seu Peso</h2>
                            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-inner min-h-[80px] flex items-center justify-center">
                                ${weight ? `<p class="text-gray-700 dark:text-gray-300 text-5xl font-extrabold">${weight} kg</p>` : `<p class="text-gray-500 dark:text-gray-400 italic text-lg text-center">Nenhum peso registrado ainda.</p>`}
                            </div>
                            <button id="open-weight-modal-btn" class="mt-6 w-full bg-white text-indigo-700 hover:bg-gray-100 font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                                ${weight ? 'Atualizar Peso' : 'Registrar Peso'}
                            </button>
                        </section>
                    </div>
                `;

                // Renderiza os modais se estiverem abertos
                renderWorkoutModal();
                renderDietModal();
                renderWeightModal();
                renderConfirmationModal();
            }

            /**
             * Renderiza a tela de detalhes de um dia específico.
             */
            function renderDayDetailScreen() {
                const dayWorkouts = workouts[currentDay];
                let dayWorkoutsList = '';
                if (dayWorkouts.length === 0) {
                    dayWorkoutsList = '<p class="text-gray-600 dark:text-gray-400 italic">Nenhum treino adicionado para este dia.</p>';
                } else {
                    dayWorkoutsList = '<ul class="list-disc list-inside space-y-1">';
                    dayWorkouts.forEach(workout => {
                        dayWorkoutsList += `
                            <li class="text-sm text-gray-700 dark:text-gray-300 flex justify-between items-center">
                                <div>
                                    <span class="font-semibold">${workout.name}:</span> ${workout.description}
                                </div>
                                <div class="flex space-x-2">
                                    <button data-day="${currentDay}" data-workout-id="${workout.id}" class="edit-workout-btn text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-600 focus:outline-none" title="Editar Treino">
                                        ✏️
                                    </button>
                                    <button data-day="${currentDay}" data-workout-id="${workout.id}" class="delete-workout-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600 focus:outline-none" title="Excluir Treino">
                                        🗑️
                                    </button>
                                </div>
                            </li>
                        `;
                    });
                    dayWorkoutsList += '</ul>';
                }

                appRoot.innerHTML = `
                    <div class="flex justify-between items-center w-full mb-10">
                        <button id="back-to-week-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                            ← Voltar para a Semana
                        </button>
                        <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500 drop-shadow-lg animate-pulse-fade">
                            ${currentDay}
                        </h1>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                            Sair
                        </button>
                    </div>

                    <div class="bg-amber-800 bg-opacity-90 text-white p-3 rounded-md mb-4 animate-fade-in text-center border-l-4 border-yellow-400">
                        <p class="font-bold text-sm mb-1">A escolha das repetições deve sempre estar alinhada com o seu objetivo principal:</p>
                        <ul class="list-disc list-inside mx-auto max-w-fit text-left text-xs">
                            <li><strong>Força (1-5 repetições):</strong> Usando cargas muito pesadas.</li>
                            <li><strong>Hipertrofia (6-12 repetições):</strong> O mais comum para ganho de massa muscular.</li>
                            <li><strong>Resistência (15+ repetições):</strong> Usando cargas leves a moderadas.</li>
                        </ul>
                    </div>

                    ${authError ? `<div class="bg-red-500 text-white p-3 rounded-md mb-4 flex justify-between items-center animate-fade-in"><span>${authError}</span><button id="clear-error-btn" class="font-bold text-lg">&times;</button></div>` : ''}

                    <section class="mb-12 w-full">
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Treinos para ${currentDay}</h2>
                        <div class="bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-700 rounded-xl p-5 shadow-lg">
                            ${dayWorkoutsList}
                            <button data-day="${currentDay}" class="add-workout-btn mt-5 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Adicionar Treino para ${currentDay}
                            </button>
                        </div>
                    </section>
                `;
                // Renderiza os modais se estiverem abertos
                renderWorkoutModal();
                renderDietModal();
                renderWeightModal();
                renderConfirmationModal();
            }

            /**
             * Renderiza o conteúdo do modal de adicionar/editar treino.
             */
            function renderWorkoutModal() {
                const title = editingWorkout ? 'Editar Treino' : `Adicionar Treino para ${currentDay}`;
                const workoutNames = Object.keys(workoutDetails);
                let workoutOptionsHtml = '<option value="">Selecione o treino</option>';
                workoutNames.forEach(name => {
                    const selected = (editingWorkout && editingWorkout.name === name) ? 'selected' : '';
                    workoutOptionsHtml += `<option value="${name}" ${selected}>${name}</option>`;
                });

                let exerciseOptionsHtml = '<option value="">Selecione o Exercício</option>';
                let initialDescription = '';
                let initialMachinesHtml = '<p class="text-gray-600 dark:text-gray-400 italic">Selecione o tipo de treino para ver as máquinas.</p>';
                let exerciseSelectDisabled = 'disabled';

                if (editingWorkout) {
                    const selectedWorkoutType = editingWorkout.name;
                    const currentWorkoutDetail = workoutDetails[selectedWorkoutType]; // Get the detail once

                    if (currentWorkoutDetail) { // Check if the workout type exists in workoutDetails
                        exerciseSelectDisabled = '';
                        // Extract just the exercise name from the saved description for pre-selection
                        const savedExerciseName = editingWorkout.description; // Description is now just the exercise name
                        currentWorkoutDetail.exercises.forEach(ex => { // Access exercises safely here
                            const selected = (savedExerciseName === ex.name) ? 'selected' : '';
                            exerciseOptionsHtml += `<option value="${ex.name}" ${selected}>${ex.name}</option>`;
                        });

                        // Populate machines for editing mode
                        if (currentWorkoutDetail.machines && currentWorkoutDetail.machines.length > 0) {
                            initialMachinesHtml = '<ul class="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300">';
                            currentWorkoutDetail.machines.forEach(machine => {
                                initialMachinesHtml += `<li><span class="font-semibold">${machine.name}:</span> ${machine.description}</li>`;
                            });
                            initialMachinesHtml += '</ul>';
                        } else {
                            initialMachinesHtml = '<p class="text-gray-600 dark:text-gray-400 italic">Nenhuma máquina específica listada para este treino.</p>';
                        }

                        // When editing, the textarea should show the full description from workoutDetails
                        const exerciseNameForEdit = editingWorkout.description; // Description is now just the exercise name
                        const fullExerciseDetail = currentWorkoutDetail.exercises.find(ex => ex.name === exerciseNameForEdit);
                        if (fullExerciseDetail) {
                            initialDescription = `${fullExerciseDetail.name}: ${fullExerciseDetail.description}`;
                        } else {
                            initialDescription = editingWorkout.description; // Fallback if not found
                        }
                    } else {
                        // Fallback if editingWorkout.name is not a valid workout type
                        exerciseSelectDisabled = 'disabled';
                        exerciseOptionsHtml = '<option value="">Selecione o Exercício</option>';
                        initialMachinesHtml = '<p class="text-gray-600 dark:text-gray-400 italic">Tipo de treino inválido ou não encontrado.</p>';
                        initialDescription = editingWorkout.description; // Keep the original saved description
                    }
                }


                const contentHtml = `
                    <form id="workout-form" class="space-y-6">
                        <div>
                            <label for="workoutName" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Tipo de Treino
                            </label>
                            <select
                                id="workoutName"
                                name="workoutName"
                                class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:bg-gray-700 dark:text-white"
                                required
                            >
                                ${workoutOptionsHtml}
                            </select>
                        </div>
                        <div>
                            <label for="workoutExercise" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Exercício
                            </label>
                            <select
                                id="workoutExercise"
                                name="workoutExercise"
                                class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:bg-gray-700 dark:text-white"
                                ${exerciseSelectDisabled}
                            >
                                ${exerciseOptionsHtml}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Máquinas
                            </label>
                            <div id="machinesBox" class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white min-h-[80px] overflow-auto">
                                ${initialMachinesHtml}
                            </div>
                        </div>
                        <div>
                            <label for="workoutDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Descrição (Exercícios e Repetições Sugeridas)
                            </label>
                            <textarea
                                id="workoutDescription"
                                name="workoutDescription"
                                rows="10"
                                class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:bg-gray-700 dark:text-white"
                                placeholder="Ex: Agachamento 3x10, Leg Press 4x12..."
                            >${initialDescription}</textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-workout-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Cancelar
                            </button>
                            <button type="submit" id="save-workout-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                ${editingWorkout ? 'Salvar Alterações' : 'Adicionar Treino'}
                            </button>
                        </div>
                    </form>
                `;
                renderModal(isWorkoutModalOpen, title, contentHtml, closeWorkoutModal);

                if (isWorkoutModalOpen) {
                    const workoutNameSelect = document.getElementById('workoutName');
                    const workoutExerciseSelect = document.getElementById('workoutExercise');
                    const workoutDescriptionTextarea = document.getElementById('workoutDescription');
                    const machinesBox = document.getElementById('machinesBox');

                    // Function to update exercise dropdown and machines box
                    function updateExerciseAndMachines(selectedWorkoutType, initialExerciseName = null) {
                        let exerciseOptionsHtml = '<option value="">Selecione o Exercício</option>';
                        let machinesHtml = '<p class="text-gray-600 dark:text-gray-400 italic">Selecione o tipo de treino para ver as máquinas.</p>';

                        const currentWorkoutDetail = workoutDetails[selectedWorkoutType];

                        if (currentWorkoutDetail) {
                            currentWorkoutDetail.exercises.forEach(ex => {
                                const selected = (initialExerciseName === ex.name) ? 'selected' : '';
                                exerciseOptionsHtml += `<option value="${ex.name}" ${selected}>${ex.name}</option>`;
                            });
                            workoutExerciseSelect.disabled = false;

                            if (currentWorkoutDetail.machines && currentWorkoutDetail.machines.length > 0) {
                                machinesHtml = '<ul class="list-disc list-inside space-y-1 text-gray-700 dark:text-gray-300">';
                                currentWorkoutDetail.machines.forEach(machine => {
                                    machinesHtml += `<li><span class="font-semibold">${machine.name}:</span> ${machine.description}</li>`;
                                });
                                machinesHtml += '</ul>';
                            } else {
                                machinesHtml = '<p class="text-gray-600 dark:text-gray-400 italic">Nenhuma máquina específica listada para este treino.</p>';
                            }
                        } else {
                            workoutExerciseSelect.disabled = true;
                        }
                        workoutExerciseSelect.innerHTML = exerciseOptionsHtml;
                        machinesBox.innerHTML = machinesHtml;
                    }

                    // Initial call to set up exercises and machines if editing
                    if (editingWorkout) {
                        const selectedWorkoutType = editingWorkout.name;
                        const savedExerciseName = editingWorkout.description; // Description is now just the exercise name
                        updateExerciseAndMachines(selectedWorkoutType, savedExerciseName);
                        // Ensure description is correctly set for editing
                        const workoutTypeForEdit = editingWorkout.name;
                        const exerciseNameForEdit = editingWorkout.description; // Description is now just the exercise name
                        if (workoutDetails[workoutTypeForEdit] && workoutDetails[workoutTypeForEdit].exercises) {
                            const fullExerciseDetail = workoutDetails[workoutTypeForEdit].exercises.find(ex => ex.name === exerciseNameForEdit);
                            if (fullExerciseDetail) {
                                workoutDescriptionTextarea.value = `${fullExerciseDetail.name}: ${fullExerciseDetail.description}`;
                            } else {
                                workoutDescriptionTextarea.value = editingWorkout.description; // Fallback if not found
                            }
                        } else {
                            workoutDescriptionTextarea.value = editingWorkout.description; // Fallback if workout type not found
                        }
                    } else {
                        // For adding new workout, ensure exercises and machines are reset
                        updateExerciseAndMachines(workoutNameSelect.value);
                    }

                    // Event listener for workout type selection
                    workoutNameSelect.onchange = (event) => {
                        const selectedWorkoutType = event.target.value;
                        updateExerciseAndMachines(selectedWorkoutType);
                        workoutDescriptionTextarea.value = ''; // Clear description when workout type changes
                    };

                    // Event listener for exercise selection
                    workoutExerciseSelect.onchange = (event) => {
                        const selectedExerciseName = event.target.value;
                        const selectedWorkoutType = workoutNameSelect.value;
                        if (workoutDetails[selectedWorkoutType]) {
                            const exercise = workoutDetails[selectedWorkoutType].exercises.find(ex => ex.name === selectedExerciseName);
                            if (exercise) {
                                workoutDescriptionTextarea.value = exercise.name + ": " + exercise.description; // Concatenate name and description
                            } else {
                                workoutDescriptionTextarea.value = '';
                            }
                        }
                    };

                    // Atribui os event listeners aos botões do formulário do modal de treino
                    document.getElementById('workout-form').onsubmit = handleSaveWorkout;
                    document.getElementById('cancel-workout-btn').onclick = closeWorkoutModal;
                }
            }

            /**
             * Renderiza o conteúdo do modal de dieta.
             */
            function renderDietModal() {
                const title = "Sua Dieta Completa";
                const contentHtml = `
                    <form id="diet-form" class="space-y-6">
                        <div>
                            <label for="dietPlan" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Plano de Dieta
                            </label>
                            <textarea
                                id="dietPlan"
                                name="dietPlan"
                                rows="10"
                                class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-gray-900 dark:bg-gray-700 dark:text-white"
                                placeholder="Descreva sua dieta para a semana, refeição por refeição."
                            >${diet}</textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-diet-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Cancelar
                            </button>
                            <button type="submit" id="save-diet-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Salvar Dieta
                            </button>
                        </div>
                    </form>
                `;
                renderModal(isDietModalOpen, title, contentHtml, closeDietModal);

                if (isDietModalOpen) {
                    // Atribui os event listeners aos botões do formulário do modal de dieta
                    document.getElementById('diet-form').onsubmit = handleSaveDiet;
                    document.getElementById('cancel-diet-btn').onclick = closeDietModal;
                }
            }

            /**
             * Renderiza o conteúdo do modal de peso.
             */
            function renderWeightModal() {
                const title = "Registrar Seu Peso";
                const contentHtml = `
                    <form id="weight-form" class="space-y-6">
                        <div>
                            <label for="newWeight" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                Peso (kg)
                            </label>
                            <input
                                type="number"
                                id="newWeight"
                                name="newWeight"
                                step="0.1"
                                min="0"
                                value="${weight}"
                                class="mt-1 block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 text-gray-900 dark:bg-gray-700 dark:text-white"
                                placeholder="Ex: 75.5"
                                required
                            />
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-weight-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Cancelar
                            </button>
                            <button type="submit" id="save-weight-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 ease-in-out transform hover:scale-105">
                                Salvar Peso
                            </button>
                        </div>
                    </form>
                `;
                renderModal(isWeightModalOpen, title, contentHtml, closeWeightModal);

                if (isWeightModalOpen) {
                    // Atribui os event listeners aos botões do formulário do modal de peso
                    document.getElementById('weight-form').onsubmit = handleSaveWeight;
                    document.getElementById('cancel-weight-btn').onclick = closeWeightModal;
                }
            }

            /**
             * Função principal de renderização que decide qual tela exibir (autenticação ou app principal).
             * Também verifica o status de carregamento do SDK do Firebase.
             */
            function renderApp() {
                // Se o Firebase ainda não estiver inicializado, mostra tela de carregamento
                if (!firebase || !auth || !db) {
                    appRoot.innerHTML = `
                        <div class="flex justify-center items-center h-full min-h-[300px] text-xl text-gray-700 dark:text-gray-300">
                            Carregando Firebase SDK...
                        </div>
                    `;
                    return;
                }

                // Se o usuário não estiver logado, renderiza a tela de autenticação
                if (!currentUser) {
                    renderAuthScreen();
                } else {
                    // Se o usuário estiver logado, renderiza a tela principal da aplicação
                    if (currentView === 'main') {
                        renderMainApp();
                    } else if (currentView === 'dayDetail') {
                        renderDayDetailScreen();
                    }
                }
            }

            // --- Inicialização da Aplicação quando o DOM estiver pronto ---
            window.onload = function() {
                // Listener para o estado de autenticação do Firebase
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        userId = user.uid;
                        await loadUserData(user); // Carrega os dados se o usuário estiver logado
                    } else {
                        currentUser = null;
                        userId = null;
                    }
                    renderApp(); // Renderiza a aplicação (tela de login ou principal)
                });

                // Adiciona o listener de delegação de eventos ao document.body UMA ÚNICA VEZ
                document.body.addEventListener('click', (event) => {
                    const target = event.target;
                    console.log('Clicked target:', target); // Log do elemento clicado

                    // Usando closest() para encontrar o botão correspondente, mesmo se o clique for em um filho
                    const clickedElement = target.closest('.add-workout-btn, .edit-workout-btn, .delete-workout-btn, #logout-btn, #clear-error-btn, #open-diet-modal-btn, #open-weight-modal-btn, #toggle-auth-mode-btn, .day-box-clickable, #back-to-week-btn');

                    if (clickedElement) {
                        console.log('Detected clicked element:', clickedElement); // Log do elemento detectado
                        if (clickedElement.matches('.add-workout-btn')) {
                            openAddWorkoutModal(clickedElement.dataset.day);
                        } else if (clickedElement.matches('.edit-workout-btn')) {
                            const day = clickedElement.dataset.day;
                            const workoutId = clickedElement.dataset.workoutId;
                            const workout = workouts[day].find(w => w.id === workoutId);
                            if (workout) openEditWorkoutModal(day, workout);
                        } else if (clickedElement.matches('.delete-workout-btn')) {
                            handleDeleteWorkoutClick(clickedElement.dataset.day, clickedElement.dataset.workoutId);
                        } else if (clickedElement.matches('#logout-btn')) {
                            handleLogout();
                        } else if (clickedElement.matches('#clear-error-btn')) {
                            clearAuthError();
                        } else if (clickedElement.matches('#open-diet-modal-btn')) {
                            openDietModal();
                        } else if (clickedElement.matches('#open-weight-modal-btn')) {
                            openWeightModal();
                        } else if (clickedElement.matches('#toggle-auth-mode-btn')) {
                            isLoginMode = !isLoginMode;
                            renderApp();
                        } else if (clickedElement.matches('.day-box-clickable')) {
                            currentDay = clickedElement.dataset.day;
                            currentView = 'dayDetail';
                            renderApp();
                        } else if (clickedElement.matches('#back-to-week-btn')) {
                            currentView = 'main';
                            renderApp();
                        }
                    }
                });
            };
        })();
    </script>
</body>
</html>
